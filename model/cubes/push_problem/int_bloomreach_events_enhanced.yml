{% set model = dbt_model('int_bloomreach_events_enhanced') %}
 
cubes:
  - {{ model.as_cube() }}

    joins:
    - name: int_af_id
      sql: "{CUBE.user_id} = {int_af_id.user_id}"
      relationship: one_to_one
    - name: countries
      sql: "{CUBE}.country_code = {countries.code}"
      relationship: one_to_one


    dimensions:
      {{ model.as_dimensions() }}
      - name: user_id
        sql: user_id
        primary_key: true
        type: number
      - name: appsflyer_id
        sql: "{int_af_id.appsflyer_id}"
        type: string
      - name: tier_name
        sql: "{countries.tier_name}"
        type: string      
 
    measures:
      - name: count
        sql: "count(*)"
        type: count
      - name: distinct_users
        sql:  "{CUBE}.user_id"      
        type: count_distinct

    segments: 
      - name: failed_pushes
        sql: "{CUBE}.action_type = 'mobile notification' AND {CUBE}.status = 'failed'"  