{% set model = dbt_model('int_bloomreach_events_enhanced') %}
 
cubes:
  - {{ model.as_cube() }}

    joins:
    - name: int_af_id
      sql: "{CUBE.user_id} = {int_af_id.user_id}"
      relationship: one_to_one
    - name: countries
      sql: "{CUBE}.country_code = {countries.code}"
      relationship: one_to_one

    measures:
      - name: event_cnt
        type: count
        drill_members:
          - status
          - error
      - name: msg_cnt
        type: count
        sql: "message_id"
        drill_members:
          - status
          - error
          - campaign_name
          - action_type
      - name: distinct_users
        sql:  "{CUBE}.user_id"      
        type: count_distinct
      - name: avg_failed
        type: avg
        sql: "cast({CUBE.if_failed} as int)*100"

      - name: token_cnt
        sql: "if({CUBE}.has_token=True, user_id, NULL)"
        type: count_distinct
      - name: hour_cnt
        sql: "EXTRACT(HOUR FROM timestamp)"
        type: count
      - name: failed_pct
        sql: "100.0 * SUM(if_failed) / COUNT(*)"
        type: number

        
    dimensions:
      {{ model.as_dimensions() }}
      - name: user_id
        sql: user_id
        primary_key: true
        type: number
      - name: event_hour
        sql: "EXTRACT(HOUR FROM timestamp)"
        type: string
      - name: google_push_notification_id
        sql:  "google_push_notification_id"
        type: string
      - name: appsflyer_id
        sql: "{int_af_id.appsflyer_id}"
        type: string
        sub_query: true
      - name: has_token
        sql: "{CUBE}.google_push_notification_id is not NULL and {CUBE}.google_push_notification_id <> ''"
        type: boolean
      - name: tier_name
        sql: "{countries.tier_name}"
        type: string
      - name: if_failed
        type: number
        sql: "case when {CUBE}.status = 'failed' then 1 else 0 end"
    segments:
      - name: pushes
        sql: "{CUBE}.action_type = 'mobile notification'" 
      - name: failed_pushes
        sql: "{CUBE}.action_type = 'mobile notification' AND {CUBE}.status = 'failed'"  